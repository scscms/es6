<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>es6-test</title>
    <script src="bin/traceur.js" type="text/javascript"></script>
    <script src="bin/bootstrap.js" type="text/javascript"></script>
</head>
<body>
<script type="module">
    var p1 = new Promise(function(resolve, reject) {
        resolve("成功");
        //reject(new Error('statusText'));
    });

    p1.then(function(value) {
        console.log(value); // "成功!"
        throw "哦，不!";
    }).catch(function(e) {
        console.log(e); // "哦，不!"
    });

    function getURLCallback(URL, callback) {
        var req = new XMLHttpRequest();
        req.open('GET', URL, true);
        req.onload = function () {
            if (req.status === 200) {
                callback(null, req.responseText);
            } else {
                callback(new Error(req.statusText), req.response);
            }
        };
        req.onerror = function () {
            callback(new Error(req.statusText));
        };
        req.send();
    }
    // <1> 对JSON数据进行安全的解析
    function jsonParse(callback, error, value) {
        if (error) {
            callback(error, value);
        } else {
            try {
                var result = JSON.parse(value);
                callback(null, result);
            } catch (e) {
                callback(e, value);
            }
        }
    }
    // <2> 发送XHR请求
    var request = {
        comment: function getComment(callback) {
            return getURLCallback('http://azu.github.io/promises-book/json/comment.json', jsonParse.bind(null, callback));
        },
        people: function getPeople(callback) {
            return getURLCallback('http://azu.github.io/promises-book/json/people.json', jsonParse.bind(null, callback));
        }
    };
    // <3> 启动多个XHR请求，当所有请求返回时调用callback
    function allRequest(requests, callback, results) {
        if (requests.length === 0) {
            return callback(null, results);
        }
        var req = requests.shift();
        req(function (error, value) {
            if (error) {
                callback(error, value);
            } else {
                results.push(value);
                allRequest(requests, callback, results);
            }
        });
    }
    allRequest([request.comment, request.people], function(error, results){error ? console.error(error) : console.log(results)}, []);
</script>
</body>
</html>